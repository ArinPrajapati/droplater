import { MongoClient, ObjectId } from 'mongodb';
import axios from "axios"
import { timeStamp } from 'console';


const MONGO_URL = process.env.MONGO_URL as string;
const client = new MongoClient(MONGO_URL);

const dbName = "droplater";

const POLL_INTERGVAL = 5000;


const backoff = (attempt: number): number => Math.pow(2, attempt) * 1000;

async function processNotes() {
    const db = client.db(dbName);
    const notes = db.collection("notes");

    const currentTime = new Date();


    const readyNotes = await notes.find({
        releaseAt: { $lte: currentTime },
        status: "pending"
    }).toArray();


    for (const note of readyNotes) {
        try {
            const res = await axios.post(note.webhookUrl, { content: note.content }, {
                headers: {
                    "X-Webhook-Id": note._id.toString(),
                    "X-Idempotency-Key": note._id.toString()
                },
                timeout: 5000
            });
            if (res.status >= 200) {
                ait notes.updateOne(
                { _id: note._id },
                {
                    $set: { status: "delivered", deliveredAt: new Date() },
                    $push: { attempts: { timestamp: new Date(), statusCode: res.status } }
                }
            );
                console.log(`âœ… Delivered note ${note._id}`);
            }
        } catch (why: any) {
            const attemptsCount = note.attempts?.length || 0;

        }

